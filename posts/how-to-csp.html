<!DOCTYPE html><html lang="en"><head><meta name="theme-color" content="#1976d2"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><script data-goatcounter-settings="{}" data-goatcounter="https://nigel.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script><title>How to CSP</title><meta name="description" content=""/><meta property="og:title" content="How to CSP"/><meta property="og:description" content=""/><meta property="og:type" content="article"/><meta property="og:locale" content="en_US"/><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/5ea27e5c9dd48442fdad.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5ea27e5c9dd48442fdad.css" data-n-g=""/><link rel="preload" href="/_next/static/css/4e839cf21ff6bf076b3f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4e839cf21ff6bf076b3f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-5c5c9a38a56b2b88ab7c.js" defer=""></script><script src="/_next/static/chunks/framework-09a88f8e6a8ced89af74.js" defer=""></script><script src="/_next/static/chunks/main-3406814bfe8b50bda517.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8ead03b130a2fd7f04b8.js" defer=""></script><script src="/_next/static/chunks/799-20844999efc25938d359.js" defer=""></script><script src="/_next/static/chunks/316-9d3837eadcdc632b6aa2.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-2ae2dd2555268f39a2dd.js" defer=""></script><script src="/_next/static/xdPsMRMMu-Y_drEnosqG-/_buildManifest.js" defer=""></script><script src="/_next/static/xdPsMRMMu-Y_drEnosqG-/_ssgManifest.js" defer=""></script><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css 1oqqzyl-MuiContainer-root 3ntvoq-MuiTypography-root-MuiLink-root bhp9pd-MuiPaper-root-MuiCard-root o69gx8-MuiCardMedia-root 46bh2p-MuiCardContent-root k008qs i9gxme gepadz-MuiTypography-root 56sg73 1iz24ed-MuiChip-root 1wlk0hk-MuiAvatar-root 1pqm26d-MuiAvatar-img 6od3lo-MuiChip-label 5lbw0b-MuiTypography-root 1ld3b9g-MuiGrid-root 1tp3ba8-MuiGrid-root b6lsxj-MuiButtonBase-root-MuiCardActionArea-root uxrmkj-MuiTypography-root-MuiLink-root ahj2mt-MuiTypography-root 1v2exvi-MuiCardActionArea-focusHighlight">.css-1oqqzyl-MuiContainer-root{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1oqqzyl-MuiContainer-root{padding-left:24px;padding-right:24px;}}@media (min-width:1200px){.css-1oqqzyl-MuiContainer-root{max-width:1200px;}}.css-3ntvoq-MuiTypography-root-MuiLink-root{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:300;font-size:6rem;line-height:1.167;letter-spacing:-0.01562em;color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-bhp9pd-MuiPaper-root-MuiCard-root{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);overflow:hidden;}.css-o69gx8-MuiCardMedia-root{display:block;-webkit-background-size:cover;background-size:cover;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;width:100%;object-fit:cover;}.css-46bh2p-MuiCardContent-root{padding:16px;}.css-46bh2p-MuiCardContent-root:last-child{padding-bottom:24px;}.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-i9gxme{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}.css-gepadz-MuiTypography-root{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:3rem;line-height:1.167;letter-spacing:0em;}.css-56sg73{-webkit-align-self:flex-end;-ms-flex-item-align:flex-end;align-self:flex-end;}.css-1iz24ed-MuiChip-root{font-family:"Roboto","Helvetica","Arial",sans-serif;font-size:0.8125rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;height:32px;color:rgba(0, 0, 0, 0.87);background-color:rgba(0, 0, 0, 0.08);border-radius:16px;white-space:nowrap;-webkit-transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;cursor:default;outline:0;-webkit-text-decoration:none;text-decoration:none;border:0;padding:0;vertical-align:middle;box-sizing:border-box;}.css-1iz24ed-MuiChip-root.Mui-disabled{opacity:0.38;pointer-events:none;}.css-1iz24ed-MuiChip-root .MuiChip-avatar{margin-left:5px;margin-right:-6px;width:24px;height:24px;color:#616161;font-size:0.75rem;}.css-1iz24ed-MuiChip-root .MuiChip-avatarColorPrimary{color:#fff;background-color:#1565c0;}.css-1iz24ed-MuiChip-root .MuiChip-avatarColorSecondary{color:#fff;background-color:#7b1fa2;}.css-1iz24ed-MuiChip-root .MuiChip-avatarSmall{margin-left:4px;margin-right:-4px;width:18px;height:18px;font-size:0.625rem;}.css-1iz24ed-MuiChip-root .MuiChip-icon{color:#616161;margin-left:5px;margin-right:-6px;}.css-1iz24ed-MuiChip-root .MuiChip-deleteIcon{-webkit-tap-highlight-color:transparent;color:rgba(0, 0, 0, 0.26);font-size:22px;cursor:pointer;margin:0 5px 0 -6px;}.css-1iz24ed-MuiChip-root .MuiChip-deleteIcon:hover{color:rgba(0, 0, 0, 0.4);}.css-1wlk0hk-MuiAvatar-root{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:40px;height:40px;font-family:"Roboto","Helvetica","Arial",sans-serif;font-size:1.25rem;line-height:1;border-radius:50%;overflow:hidden;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.css-1pqm26d-MuiAvatar-img{width:100%;height:100%;text-align:center;object-fit:cover;color:transparent;text-indent:10000px;}.css-6od3lo-MuiChip-label{overflow:hidden;text-overflow:ellipsis;padding-left:12px;padding-right:12px;white-space:nowrap;}.css-5lbw0b-MuiTypography-root{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:2.125rem;line-height:1.235;letter-spacing:0.00735em;}.css-1ld3b9g-MuiGrid-root{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;margin-top:-40px;width:calc(100% + 40px);margin-left:-40px;}.css-1ld3b9g-MuiGrid-root>.MuiGrid-item{padding-top:40px;}.css-1ld3b9g-MuiGrid-root>.MuiGrid-item{padding-left:40px;}.css-1tp3ba8-MuiGrid-root{box-sizing:border-box;margin:0;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:100%;}@media (min-width:900px){.css-1tp3ba8-MuiGrid-root{-webkit-flex-basis:50%;-ms-flex-preferred-size:50%;flex-basis:50%;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;max-width:50%;}}.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;display:block;text-align:inherit;width:100%;}.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root::-moz-focus-inner{border-style:none;}.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root:hover .MuiCardActionArea-focusHighlight{opacity:0.04;}@media (hover: none){.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root:hover .MuiCardActionArea-focusHighlight{opacity:0;}}.css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root.Mui-focusVisible .MuiCardActionArea-focusHighlight{opacity:0.12;}.css-uxrmkj-MuiTypography-root-MuiLink-root{margin:0;color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-ahj2mt-MuiTypography-root{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}.css-1v2exvi-MuiCardActionArea-focusHighlight{overflow:hidden;pointer-events:none;position:absolute;top:0;right:0;bottom:0;left:0;border-radius:inherit;opacity:0;background-color:currentcolor;-webkit-transition:opacity 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:opacity 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;}</style></head><body><div id="__next"><div class="min-h-screen"><div class="border-b bg-accent-1 border-accent-2"><div class="MuiContainer-root MuiContainer-maxWidthLg css-1oqqzyl-MuiContainer-root"><div class="py-2 text-center text-sm"></div></div></div><main><div class="MuiContainer-root MuiContainer-maxWidthLg css-1oqqzyl-MuiContainer-root"><a class="MuiTypography-root MuiTypography-h1 MuiLink-root MuiLink-underlineNone css-3ntvoq-MuiTypography-root-MuiLink-root" href="/">Nigel&#x27;s Blog.</a><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-bhp9pd-MuiPaper-root-MuiCard-root"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-o69gx8-MuiCardMedia-root"/><div class="MuiCardContent-root css-46bh2p-MuiCardContent-root"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h1 class="MuiTypography-root MuiTypography-h3 css-gepadz-MuiTypography-root">How to CSP</h1></div><div class="MuiBox-root css-56sg73"><div class="MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-filledDefault css-1iz24ed-MuiChip-root"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-1wlk0hk-MuiAvatar-root"><img alt="Nigel Schuster" src="https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1pqm26d-MuiAvatar-img"/></div><span class="MuiChip-label MuiChip-labelMedium css-6od3lo-MuiChip-label">Nigel Schuster</span></div></div></div><p>I was recently looking at a friend&#x27;s project. One peculiar thing that piqued my interest was the CSP policy they had configured. The relevant section of their <code>webpack.config.js</code> was:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-variable hljs-constant">ONLOAD_NONCE</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>.<span class="hljs-title hljs-function">substring</span>(<span class="hljs-number">2</span>, <span class="hljs-number">8</span>);
...
<span class="hljs-keyword">new</span> <span class="hljs-title hljs-class">CspHtmlWebpackPlugin</span>({
  <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>,
  <span class="hljs-string">&#x27;script-src&#x27;</span>: <span class="hljs-string">`&#x27;self&#x27; &#x27;nonce-<span class="hljs-subst">${ONLOAD_NONCE}</span>&#x27;`</span>,
}),
</code></pre>
<p>and their <code>index.html</code> was:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;&lt;%= htmlWebpackPlugin.options.onloadNonce %&gt;&quot;</span>&gt;</span><span class="javascript">
    <span class="hljs-variable hljs-language">console</span>.<span class="hljs-title hljs-function">log</span>(<span class="hljs-string">&quot;Hello World&quot;</span>);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<p>The reasoning is clear: They added the inline script and Chrome started complaining about it violating the CSP policy. The easiest way to solve this is to add a nonce. Unfortunately this solution effectively disables any protection that CSP offers. Crucially, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">spec</a> states:</p>
<blockquote>
<p>The server must generate a unique nonce value each time it transmits a policy.</p>
</blockquote>
<p>By including the nonce as part of the build process, it will be the same for all clients using assets with that build version.</p>
<h2>How can an attacker leverage this?</h2>
<p>Remember that CSP is another layer of defence. It by itself not working will not make a website vulnerable. Therefore we have to assume that there are other flaws in the website. Here is an example of how an XSS attack could happen:</p>
<p>At some point you decided to add a rich text field to your application, so that users can post well formatted messages. Since you are using react, you can simply use <code>&lt;div dangerouslySetInnerHTML={post()} /&gt;</code> to display the data. Unfortunately an attacker discovered that, that they crafted a post content that can behave maliciously:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable hljs-language">console</span>.<span class="hljs-title hljs-function">log</span>(<span class="hljs-string">&quot;I can access your private data&quot;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>Any user viewing the post is now at risk of having their browser data, such as cookies, stolen. Thanks to your CSP policy this inline code will not execute. However, with a nonce per build the attacker can craft the post content to be:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;nonce-from-last-build&quot;</span>&gt;</span><span class="javascript"><span class="hljs-variable hljs-language">console</span>.<span class="hljs-title hljs-function">log</span>(<span class="hljs-string">&quot;I can access your private data&quot;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>This script will happily be executed by the browser.</p>
<h2>What should they have done instead?</h2>
<p>There are two approaches to mitigate this issue. Whenever you can, you should favor the hash based approach, but in some cases that may not be possible.</p>
<h3>Hash</h3>
<p>Instead of using a nonce for the script, it is sufficient to list the sha hash of the script in the CSP policy:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">new</span> <span class="hljs-title hljs-class">CspHtmlWebpackPlugin</span>({
  <span class="hljs-string">&#x27;default-src&#x27;</span>: <span class="hljs-string">&quot;&#x27;self&#x27;&quot;</span>,
  <span class="hljs-string">&#x27;script-src&#x27;</span>: <span class="hljs-string">`&#x27;self&#x27; &#x27;sha256-<span class="hljs-subst">${HASH_OF_SCRIPT}</span>&#x27;`</span>,
}),
</code></pre>
<p>In fact the plugin will do that automatically if the script is part of the build graph, so that you don&#x27;t even need to list the hash.</p>
<p>In this approach we allowlist scripts with certain hashes. Since it is close to impossible to craft a script that matches the hash of an existing hash, this is sufficient to validate that a script is meant to be run.</p>
<h3>Per request nonce</h3>
<p>If the hash based approach does not suffice, you will need to generate a new nonce per request. This nonce should be inserted into the html sent to the client (potentially using a templating engine like ejs). Assuming you use <a href="https://webpack.js.org/guides/csp/">webpack</a>, you should have something similar to the following block in the html file:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;your-nonce&quot;</span>&gt;</span><span class="javascript">
__webpack_nonce__ = <span class="hljs-string">&#x27;your-nonce&#x27;</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>This will allow webpack to leverage the generated nonce as needed.</p><div></div></div></div><hr class="border-accent-2 mt-28 mb-24"/><div><h4 class="MuiTypography-root MuiTypography-h4 css-5lbw0b-MuiTypography-root">More Stories</h4><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-5 css-1ld3b9g-MuiGrid-root"><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-md-6 css-1tp3ba8-MuiGrid-root"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-bhp9pd-MuiPaper-root-MuiCard-root"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-o69gx8-MuiCardMedia-root"/><div class="MuiCardContent-root css-46bh2p-MuiCardContent-root"><button class="MuiButtonBase-root MuiCardActionArea-root css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-uxrmkj-MuiTypography-root-MuiLink-root" href="/posts/avoid-generic-types"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-5lbw0b-MuiTypography-root">Avoiding generic types for safer code</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-filledDefault css-1iz24ed-MuiChip-root"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-1wlk0hk-MuiAvatar-root"><img alt="Nigel Schuster" src="https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1pqm26d-MuiAvatar-img"/></div><span class="MuiChip-label MuiChip-labelMedium css-6od3lo-MuiChip-label">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root">Using generic types like strings made me make mistakes on several occasion. There is a better way.</p></a><span class="MuiCardActionArea-focusHighlight css-1v2exvi-MuiCardActionArea-focusHighlight"></span></button></div></div></div><div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-md-6 css-1tp3ba8-MuiGrid-root"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-bhp9pd-MuiPaper-root-MuiCard-root"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-o69gx8-MuiCardMedia-root"/><div class="MuiCardContent-root css-46bh2p-MuiCardContent-root"><button class="MuiButtonBase-root MuiCardActionArea-root css-b6lsxj-MuiButtonBase-root-MuiCardActionArea-root" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-uxrmkj-MuiTypography-root-MuiLink-root" href="/posts/object-destructuring"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-5lbw0b-MuiTypography-root">Why object destructuring is awesome</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-filledDefault css-1iz24ed-MuiChip-root"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-1wlk0hk-MuiAvatar-root"><img alt="Nigel Schuster" src="https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1pqm26d-MuiAvatar-img"/></div><span class="MuiChip-label MuiChip-labelMedium css-6od3lo-MuiChip-label">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-ahj2mt-MuiTypography-root">Object destructuring makes it easier to ensure you use all fields and avoids dead code.</p></a><span class="MuiCardActionArea-focusHighlight css-1v2exvi-MuiCardActionArea-focusHighlight"></span></button></div></div></div></div></div></div></main></div><footer class="bg-accent-1 border-t border-accent-2"><div class="MuiContainer-root MuiContainer-maxWidthLg css-1oqqzyl-MuiContainer-root"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-5xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">Nigel Schuster&#x27;s blog.</h3></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"__typename":"Query","moreStories":[{"__typename":"Post","author":{"__typename":"Author","name":"Nigel Schuster","picture":{"__typename":"Asset","url":"https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}},"coverImage":null,"excerpt":"Using generic types like strings made me make mistakes on several occasion. There is a better way.","slug":"avoid-generic-types","title":"Avoiding generic types for safer code"},{"__typename":"Post","author":{"__typename":"Author","name":"Nigel Schuster","picture":{"__typename":"Asset","url":"https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}},"coverImage":null,"excerpt":"Object destructuring makes it easier to ensure you use all fields and avoids dead code.","slug":"object-destructuring","title":"Why object destructuring is awesome"}],"post":{"__typename":"Post","author":{"__typename":"Author","name":"Nigel Schuster","picture":{"__typename":"Asset","url":"https://media.graphcms.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}},"content":"I was recently looking at a friend's project. One peculiar thing that piqued my interest was the CSP policy they had configured. The relevant section of their `webpack.config.js` was:\n```js\nconst ONLOAD_NONCE = `${Math.random()}`.substring(2, 8);\n...\nnew CspHtmlWebpackPlugin({\n  'default-src': \"'self'\",\n  'script-src': `'self' 'nonce-${ONLOAD_NONCE}'`,\n}),\n```\nand their `index.html` was:\n```html\n\u003chead\u003e\n  \u003cscript nonce=\"\u003c%= htmlWebpackPlugin.options.onloadNonce %\u003e\"\u003e\n    console.log(\"Hello World\");\n  \u003c/script\u003e\n\u003c/head\u003e\n```\nThe reasoning is clear: They added the inline script and Chrome started complaining about it violating the CSP policy. The easiest way to solve this is to add a nonce. Unfortunately this solution effectively disables any protection that CSP offers. Crucially, the [spec](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy) states: \n\n\u003e The server must generate a unique nonce value each time it transmits a policy.\n\nBy including the nonce as part of the build process, it will be the same for all clients using assets with that build version.\n\n## How can an attacker leverage this?\n\nRemember that CSP is another layer of defence. It by itself not working will not make a website vulnerable. Therefore we have to assume that there are other flaws in the website. Here is an example of how an XSS attack could happen:\n\nAt some point you decided to add a rich text field to your application, so that users can post well formatted messages. Since you are using react, you can simply use `\u003cdiv dangerouslySetInnerHTML={post()} /\u003e` to display the data. Unfortunately an attacker discovered that, that they crafted a post content that can behave maliciously:\n```html\n\u003cscript\u003econsole.log(\"I can access your private data\")\u003c/script\u003e\n```\nAny user viewing the post is now at risk of having their browser data, such as cookies, stolen. Thanks to your CSP policy this inline code will not execute. However, with a nonce per build the attacker can craft the post content to be:\n```html\n\u003cscript nonce=\"nonce-from-last-build\"\u003econsole.log(\"I can access your private data\")\u003c/script\u003e\n```\nThis script will happily be executed by the browser.\n\n## What should they have done instead?\n\nThere are two approaches to mitigate this issue. Whenever you can, you should favor the hash based approach, but in some cases that may not be possible.\n\n### Hash\n\nInstead of using a nonce for the script, it is sufficient to list the sha hash of the script in the CSP policy:\n```js\nnew CspHtmlWebpackPlugin({\n  'default-src': \"'self'\",\n  'script-src': `'self' 'sha256-${HASH_OF_SCRIPT}'`,\n}),\n```\nIn fact the plugin will do that automatically if the script is part of the build graph, so that you don't even need to list the hash.\n\nIn this approach we allowlist scripts with certain hashes. Since it is close to impossible to craft a script that matches the hash of an existing hash, this is sufficient to validate that a script is meant to be run.\n\n### Per request nonce\nIf the hash based approach does not suffice, you will need to generate a new nonce per request. This nonce should be inserted into the html sent to the client (potentially using a templating engine like ejs). Assuming you use [webpack](https://webpack.js.org/guides/csp/), you should have something similar to the following block in the html file:\n```html\n\u003cscript nonce=\"your-nonce\"\u003e\n__webpack_nonce__ = 'your-nonce';\n\u003c/script\u003e\n```\nThis will allow webpack to leverage the generated nonce as needed.","coverImage":null,"date":"2021-08-29","ogImage":null,"slug":"how-to-csp","title":"How to CSP"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"how-to-csp"},"buildId":"xdPsMRMMu-Y_drEnosqG-","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>