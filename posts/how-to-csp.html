<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta content="initial-scale=1, width=device-width" name="viewport"/><link href="https://www.nigel-schuster.de/posts/how-to-csp" rel="canonical"/><link href="/favicon/apple-touch-icon.png" sizes="180x180"/><link href="/favicon/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/favicon/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/><link href="/favicon/site.webmanifest" rel="manifest"/><link color="#000000" href="/favicon/safari-pinned-tab.svg"/><link href="/favicon/favicon.ico" rel="icon"/><meta content="#000000" name="msapplication-TileColor"/><meta content="/favicon/browserconfig.xml" name="msapplication-config"/><meta content="#000" name="theme-color"/><link href="/feed.xml" rel="alternate" type="application/rss+xml"/><script async="" data-goatcounter="https://nigel.goatcounter.com/count" data-goatcounter-settings="{}" src="//gc.zgo.at/count.js"></script><title>How to CSP</title><meta content="" name="description"/><meta content="How to CSP" property="og:title"/><meta content="" property="og:description"/><meta content="article" property="og:type"/><meta content="en_US" property="og:locale"/><meta name="next-head-count" content="20"/><meta content="#1976d2" name="theme-color"/><link rel="preload" href="/_next/static/css/727973242bb33abd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/727973242bb33abd.css" data-n-g=""/><link rel="preload" href="/_next/static/css/2aec7fdc1f1ca4ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2aec7fdc1f1ca4ae.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-74c5770b086bb7e4.js" defer=""></script><script src="/_next/static/chunks/framework-0affefb16308ed4d.js" defer=""></script><script src="/_next/static/chunks/main-8a46e03c8fcd1986.js" defer=""></script><script src="/_next/static/chunks/pages/_app-04cb59cbf3d7915b.js" defer=""></script><script src="/_next/static/chunks/112-fdf3083d8bccfd27.js" defer=""></script><script src="/_next/static/chunks/54-f89b83855f4f91e7.js" defer=""></script><script src="/_next/static/chunks/771-b04f589a7734dbad.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d5f231fa3a880432.js" defer=""></script><script src="/_next/static/El3pdoQ6FEpj7MD5X7Tzh/_buildManifest.js" defer=""></script><script src="/_next/static/El3pdoQ6FEpj7MD5X7Tzh/_ssgManifest.js" defer=""></script><script src="/_next/static/El3pdoQ6FEpj7MD5X7Tzh/_middlewareManifest.js" defer=""></script><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css "></style></head><body><div id="__next"><div class="min-h-screen"><main><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><a class="MuiTypography-root MuiTypography-h1 MuiLink-root MuiLink-underlineNone css-wpxufe" href="/">Yet another SWE Blog.</a><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h1 class="MuiTypography-root MuiTypography-h3 css-lq9rk4">How to CSP</h1></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p>I was recently looking at a friend&#x27;s project. One peculiar thing that piqued my interest was the CSP policy they had configured. The relevant section of their <!-- --><code>webpack.config.js<!-- --></code> was:<!-- --></p>
<!-- --><pre><code class="hljs language-js"><span class="hljs-keyword">const<!-- --></span> <!-- --><span class="hljs-variable hljs-constant">ONLOAD_NONCE<!-- --></span> = <!-- --><span class="hljs-string">`<!-- --><span class="hljs-subst">${<!-- --><span class="hljs-built_in">Math<!-- --></span>.random()}<!-- --></span>`<!-- --></span>.<!-- --><span class="hljs-title hljs-function">substring<!-- --></span>(<!-- --><span class="hljs-number">2<!-- --></span>, <!-- --><span class="hljs-number">8<!-- --></span>);
...
<!-- --><span class="hljs-keyword">new<!-- --></span> <!-- --><span class="hljs-title hljs-class">CspHtmlWebpackPlugin<!-- --></span>({
  <!-- --><span class="hljs-string">&#x27;default-src&#x27;<!-- --></span>: <!-- --><span class="hljs-string">&quot;&#x27;self&#x27;&quot;<!-- --></span>,
  <!-- --><span class="hljs-string">&#x27;script-src&#x27;<!-- --></span>: <!-- --><span class="hljs-string">`&#x27;self&#x27; &#x27;nonce-<!-- --><span class="hljs-subst">${ONLOAD_NONCE}<!-- --></span>&#x27;`<!-- --></span>,
}),
<!-- --></code></pre>
<!-- --><p>and their <!-- --><code>index.html<!-- --></code> was:<!-- --></p>
<!-- --><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<!-- --><span class="hljs-name">head<!-- --></span>&gt;<!-- --></span>
  <!-- --><span class="hljs-tag">&lt;<!-- --><span class="hljs-name">script<!-- --></span> <!-- --><span class="hljs-attr">nonce<!-- --></span>=<!-- --><span class="hljs-string">&quot;&lt;%= htmlWebpackPlugin.options.onloadNonce %&gt;&quot;<!-- --></span>&gt;<!-- --></span><span class="javascript">
    <!-- --><span class="hljs-variable hljs-language">console<!-- --></span>.<!-- --><span class="hljs-title hljs-function">log<!-- --></span>(<!-- --><span class="hljs-string">&quot;Hello World&quot;<!-- --></span>);
  <!-- --></span><span class="hljs-tag">&lt;/<!-- --><span class="hljs-name">script<!-- --></span>&gt;<!-- --></span>
<!-- --><span class="hljs-tag">&lt;/<!-- --><span class="hljs-name">head<!-- --></span>&gt;<!-- --></span>
<!-- --></code></pre>
<!-- --><p>The reasoning is clear: They added the inline script and Chrome started complaining about it violating the CSP policy. The easiest way to solve this is to add a nonce. Unfortunately this solution effectively disables any protection that CSP offers. Crucially, the <!-- --><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">spec<!-- --></a> states:<!-- --></p>
<!-- --><blockquote>
<!-- --><p>The server must generate a unique nonce value each time it transmits a policy.<!-- --></p>
<!-- --></blockquote>
<!-- --><p>By including the nonce as part of the build process, it will be the same for all clients using assets with that build version.<!-- --></p>
<!-- --><h2>How can an attacker leverage this?<!-- --></h2>
<!-- --><p>Remember that CSP is another layer of defence. It by itself not working will not make a website vulnerable. Therefore we have to assume that there are other flaws in the website. Here is an example of how an XSS attack could happen:<!-- --></p>
<!-- --><p>At some point you decided to add a rich text field to your application, so that users can post well formatted messages. Since you are using react, you can simply use <!-- --><code>&lt;div dangerouslySetInnerHTML={post()} /&gt;<!-- --></code> to display the data. Unfortunately an attacker discovered that, that they crafted a post content that can behave maliciously:<!-- --></p>
<!-- --><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<!-- --><span class="hljs-name">script<!-- --></span>&gt;<!-- --></span><span class="javascript"><span class="hljs-variable hljs-language">console<!-- --></span>.<!-- --><span class="hljs-title hljs-function">log<!-- --></span>(<!-- --><span class="hljs-string">&quot;I can access your private data&quot;<!-- --></span>)<!-- --></span><span class="hljs-tag">&lt;/<!-- --><span class="hljs-name">script<!-- --></span>&gt;<!-- --></span>
<!-- --></code></pre>
<!-- --><p>Any user viewing the post is now at risk of having their browser data, such as cookies, stolen. Thanks to your CSP policy this inline code will not execute. However, with a nonce per build the attacker can craft the post content to be:<!-- --></p>
<!-- --><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<!-- --><span class="hljs-name">script<!-- --></span> <!-- --><span class="hljs-attr">nonce<!-- --></span>=<!-- --><span class="hljs-string">&quot;nonce-from-last-build&quot;<!-- --></span>&gt;<!-- --></span><span class="javascript"><span class="hljs-variable hljs-language">console<!-- --></span>.<!-- --><span class="hljs-title hljs-function">log<!-- --></span>(<!-- --><span class="hljs-string">&quot;I can access your private data&quot;<!-- --></span>)<!-- --></span><span class="hljs-tag">&lt;/<!-- --><span class="hljs-name">script<!-- --></span>&gt;<!-- --></span>
<!-- --></code></pre>
<!-- --><p>This script will happily be executed by the browser.<!-- --></p>
<!-- --><h2>What should they have done instead?<!-- --></h2>
<!-- --><p>There are two approaches to mitigate this issue. Whenever you can, you should favor the hash based approach, but in some cases that may not be possible.<!-- --></p>
<!-- --><h3>Hash<!-- --></h3>
<!-- --><p>Instead of using a nonce for the script, it is sufficient to list the sha hash of the script in the CSP policy:<!-- --></p>
<!-- --><pre><code class="hljs language-js"><span class="hljs-keyword">new<!-- --></span> <!-- --><span class="hljs-title hljs-class">CspHtmlWebpackPlugin<!-- --></span>({
  <!-- --><span class="hljs-string">&#x27;default-src&#x27;<!-- --></span>: <!-- --><span class="hljs-string">&quot;&#x27;self&#x27;&quot;<!-- --></span>,
  <!-- --><span class="hljs-string">&#x27;script-src&#x27;<!-- --></span>: <!-- --><span class="hljs-string">`&#x27;self&#x27; &#x27;sha256-<!-- --><span class="hljs-subst">${HASH_OF_SCRIPT}<!-- --></span>&#x27;`<!-- --></span>,
}),
<!-- --></code></pre>
<!-- --><p>In fact the plugin will do that automatically if the script is part of the build graph, so that you don&#x27;t even need to list the hash.<!-- --></p>
<!-- --><p>In this approach we allowlist scripts with certain hashes. Since it is close to impossible to craft a script that matches the hash of an existing hash, this is sufficient to validate that a script is meant to be run.<!-- --></p>
<!-- --><h3>Per request nonce<!-- --></h3>
<!-- --><p>If the hash based approach does not suffice, you will need to generate a new nonce per request. This nonce should be inserted into the html sent to the client (potentially using a templating engine like ejs). Assuming you use <!-- --><a href="https://webpack.js.org/guides/csp/">webpack<!-- --></a>, you should have something similar to the following block in the html file:<!-- --></p>
<!-- --><pre><code class="hljs language-html"><span class="hljs-tag">&lt;<!-- --><span class="hljs-name">script<!-- --></span> <!-- --><span class="hljs-attr">nonce<!-- --></span>=<!-- --><span class="hljs-string">&quot;your-nonce&quot;<!-- --></span>&gt;<!-- --></span><span class="javascript">
__webpack_nonce__ = <!-- --><span class="hljs-string">&#x27;your-nonce&#x27;<!-- --></span>;
<!-- --></span><span class="hljs-tag">&lt;/<!-- --><span class="hljs-name">script<!-- --></span>&gt;<!-- --></span>
<!-- --></code></pre>
<!-- --><p>This will allow webpack to leverage the generated nonce as needed.<!-- --></p><p class="MuiTypography-root MuiTypography-body1 css-1bw4yx3">Published on <!-- -->2021-08-29<!-- -->.<!-- --></p></div></div><hr class="border-accent-2 mt-28 mb-24"/><div><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">More Stories</h4><div class="MuiMasonry-root css-g8y262"><div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><button class="MuiButtonBase-root MuiCardActionArea-root css-1jluznr" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-1qeofn3" href="/posts/systemd-frustration"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">Systemd Services are frustratingly hard to make safe</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">This article takes a dive into what it takes to set up a systemd service with the principle of least privilege.</p></a><span class="MuiCardActionArea-focusHighlight css-jo3ec3"></span></button></div></div></div><div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><button class="MuiButtonBase-root MuiCardActionArea-root css-1jluznr" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-1qeofn3" href="/posts/variants-are-powerful"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">Variants are incredibly powerful</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Variants are an incredibly powerful tool to express the state of your program!</p></a><span class="MuiCardActionArea-focusHighlight css-jo3ec3"></span></button></div></div></div></div></div></div></main></div><footer><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Built with NextJS. Find the source <!-- --><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-19t329g" href="https://github.com/Neitsch/neitsch.github.io">here</a>.<!-- --></p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"__typename":"Post","title":"How to CSP","slug":"how-to-csp","content":"I was recently looking at a friend's project. One peculiar thing that piqued my interest was the CSP policy they had configured. The relevant section of their `webpack.config.js` was:\n```js\nconst ONLOAD_NONCE = `${Math.random()}`.substring(2, 8);\n...\nnew CspHtmlWebpackPlugin({\n  'default-src': \"'self'\",\n  'script-src': `'self' 'nonce-${ONLOAD_NONCE}'`,\n}),\n```\nand their `index.html` was:\n```html\n\u003chead\u003e\n  \u003cscript nonce=\"\u003c%= htmlWebpackPlugin.options.onloadNonce %\u003e\"\u003e\n    console.log(\"Hello World\");\n  \u003c/script\u003e\n\u003c/head\u003e\n```\nThe reasoning is clear: They added the inline script and Chrome started complaining about it violating the CSP policy. The easiest way to solve this is to add a nonce. Unfortunately this solution effectively disables any protection that CSP offers. Crucially, the [spec](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy) states: \n\n\u003e The server must generate a unique nonce value each time it transmits a policy.\n\nBy including the nonce as part of the build process, it will be the same for all clients using assets with that build version.\n\n## How can an attacker leverage this?\n\nRemember that CSP is another layer of defence. It by itself not working will not make a website vulnerable. Therefore we have to assume that there are other flaws in the website. Here is an example of how an XSS attack could happen:\n\nAt some point you decided to add a rich text field to your application, so that users can post well formatted messages. Since you are using react, you can simply use `\u003cdiv dangerouslySetInnerHTML={post()} /\u003e` to display the data. Unfortunately an attacker discovered that, that they crafted a post content that can behave maliciously:\n```html\n\u003cscript\u003econsole.log(\"I can access your private data\")\u003c/script\u003e\n```\nAny user viewing the post is now at risk of having their browser data, such as cookies, stolen. Thanks to your CSP policy this inline code will not execute. However, with a nonce per build the attacker can craft the post content to be:\n```html\n\u003cscript nonce=\"nonce-from-last-build\"\u003econsole.log(\"I can access your private data\")\u003c/script\u003e\n```\nThis script will happily be executed by the browser.\n\n## What should they have done instead?\n\nThere are two approaches to mitigate this issue. Whenever you can, you should favor the hash based approach, but in some cases that may not be possible.\n\n### Hash\n\nInstead of using a nonce for the script, it is sufficient to list the sha hash of the script in the CSP policy:\n```js\nnew CspHtmlWebpackPlugin({\n  'default-src': \"'self'\",\n  'script-src': `'self' 'sha256-${HASH_OF_SCRIPT}'`,\n}),\n```\nIn fact the plugin will do that automatically if the script is part of the build graph, so that you don't even need to list the hash.\n\nIn this approach we allowlist scripts with certain hashes. Since it is close to impossible to craft a script that matches the hash of an existing hash, this is sufficient to validate that a script is meant to be run.\n\n### Per request nonce\nIf the hash based approach does not suffice, you will need to generate a new nonce per request. This nonce should be inserted into the html sent to the client (potentially using a templating engine like ejs). Assuming you use [webpack](https://webpack.js.org/guides/csp/), you should have something similar to the following block in the html file:\n```html\n\u003cscript nonce=\"your-nonce\"\u003e\n__webpack_nonce__ = 'your-nonce';\n\u003c/script\u003e\n```\nThis will allow webpack to leverage the generated nonce as needed.","date":"2021-08-29","ogImage":null,"coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}},"moreStories":[{"__typename":"Post","title":"Systemd Services are frustratingly hard to make safe","slug":"systemd-frustration","excerpt":"This article takes a dive into what it takes to set up a systemd service with the principle of least privilege.","coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}},{"__typename":"Post","title":"Variants are incredibly powerful","slug":"variants-are-powerful","excerpt":"Variants are an incredibly powerful tool to express the state of your program!","coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}}],"__typename":"Query"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"how-to-csp"},"buildId":"El3pdoQ6FEpj7MD5X7Tzh","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>