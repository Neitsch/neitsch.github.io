<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta content="initial-scale=1, width=device-width" name="viewport"/><link href="https://www.nigel-schuster.de/posts/systemd-frustration" rel="canonical"/><link href="/favicon/apple-touch-icon.png" sizes="180x180"/><link href="/favicon/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/favicon/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/><link href="/favicon/site.webmanifest" rel="manifest"/><link color="#000000" href="/favicon/safari-pinned-tab.svg"/><link href="/favicon/favicon.ico" rel="icon"/><meta content="#000000" name="msapplication-TileColor"/><meta content="/favicon/browserconfig.xml" name="msapplication-config"/><meta content="#000" name="theme-color"/><link href="/feed.xml" rel="alternate" type="application/rss+xml"/><script async="" data-goatcounter="https://nigel.goatcounter.com/count" data-goatcounter-settings="{}" src="//gc.zgo.at/count.js"></script><title>Systemd Services are frustratingly hard to make safe</title><meta content="" name="description"/><meta content="Systemd Services are frustratingly hard to make safe" property="og:title"/><meta content="" property="og:description"/><meta content="article" property="og:type"/><meta content="en_US" property="og:locale"/><meta name="next-head-count" content="20"/><meta content="#1976d2" name="theme-color"/><link rel="preload" href="/_next/static/css/727973242bb33abd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/727973242bb33abd.css" data-n-g=""/><link rel="preload" href="/_next/static/css/2aec7fdc1f1ca4ae.css" as="style"/><link rel="stylesheet" href="/_next/static/css/2aec7fdc1f1ca4ae.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-74c5770b086bb7e4.js" defer=""></script><script src="/_next/static/chunks/framework-0affefb16308ed4d.js" defer=""></script><script src="/_next/static/chunks/main-fd45cda75bca1523.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0c142fa388464df3.js" defer=""></script><script src="/_next/static/chunks/742-2951a694794a7f02.js" defer=""></script><script src="/_next/static/chunks/2-bb92b70d253ffb35.js" defer=""></script><script src="/_next/static/chunks/139-fec39532486e74be.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-f11a485f51a1909d.js" defer=""></script><script src="/_next/static/Dr3hmog3a1IWTPaX95YpU/_buildManifest.js" defer=""></script><script src="/_next/static/Dr3hmog3a1IWTPaX95YpU/_ssgManifest.js" defer=""></script><script src="/_next/static/Dr3hmog3a1IWTPaX95YpU/_middlewareManifest.js" defer=""></script><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css "></style></head><body><div id="__next"><div class="min-h-screen"><main><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><a class="MuiTypography-root MuiTypography-h1 MuiLink-root MuiLink-underlineNone css-5ix4ge" href="/">Yet another SWE Blog.</a><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h1 class="MuiTypography-root MuiTypography-h3 css-lq9rk4">Systemd Services are frustratingly hard to make safe</h1></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p>Today&#x27;s story starts with me wanting to reduce the permissions of some of the systemd services I run. The two services I set my sight on were <!-- --><a href="https://github.com/evilsocket/opensnitch">opensnitch<!-- --></a>, a system service, and <!-- --><a href="https://github.com/ProtonMail/proton-bridge">protonmail-bridge<!-- --></a>, a user service.<!-- --></p>
<!-- --><h1>Opensnitch<!-- --></h1>
<!-- --><p>Conveniently opensnitch provides a working <!-- --><a href="https://github.com/evilsocket/opensnitch/blob/0d1e9f5b4750cc7932eb42618d7c4b2b87022dc7/daemon/opensnitchd.service">systemd unit<!-- --></a>:<!-- --></p>
<!-- --><pre><code class="hljs language-ini"><span class="hljs-section">[Unit]<!-- --></span>
<!-- --><span class="hljs-attr">Description<!-- --></span>=OpenSnitch is a GNU/Linux port of the Little Snitch application firewall.
<!-- --><span class="hljs-attr">Documentation<!-- --></span>=https://github.com/gustavo-iniguez-goya/opensnitch/wiki
<!-- --><span class="hljs-attr">Wants<!-- --></span>=network.target
<!-- --><span class="hljs-attr">After<!-- --></span>=network.target

<!-- --><span class="hljs-section">[Service]<!-- --></span>
<!-- --><span class="hljs-attr">Type<!-- --></span>=simple
<!-- --><span class="hljs-attr">PermissionsStartOnly<!-- --></span>=<!-- --><span class="hljs-literal">true<!-- --></span>
<!-- --><span class="hljs-attr">ExecStartPre<!-- --></span>=/bin/mkdir -p /etc/opensnitchd/rules
<!-- --><span class="hljs-attr">ExecStart<!-- --></span>=/usr/local/bin/opensnitchd -rules-path /etc/opensnitchd/rules
<!-- --><span class="hljs-attr">Restart<!-- --></span>=always
<!-- --><span class="hljs-attr">RestartSec<!-- --></span>=<!-- --><span class="hljs-number">30<!-- --></span>

<!-- --><span class="hljs-section">[Install]<!-- --></span>
<!-- --><span class="hljs-attr">WantedBy<!-- --></span>=multi-user.target
<!-- --></code></pre>
<!-- --><p>Let&#x27;s break down what this unit does:<!-- --></p>
<!-- --><ul>
<!-- --><li><code>Description<!-- --></code> and <!-- --><code>Documentation<!-- --></code> are quite self explanatory and don&#x27;t affect the runtime of the unit.<!-- --></li>
<!-- --><li><code>Wants=network.target<!-- --></code> means that this service may only be started after the networking layer has been initialized.<!-- --></li>
<!-- --><li><code>After=network.target<!-- --></code> means that this service should automatically be started once the networking layer has been initialized.<!-- --></li>
<!-- --><li><code>Type=simple<!-- --></code> specifies how the unit launches. <!-- --><code>simple<!-- --></code> is often the right choice, but processes that daemonize itself for example will be <!-- --><code>forking<!-- --></code>.<!-- --></li>
<!-- --><li><code>PermissionsStartOnly=true<!-- --></code> is a deprecated attribute that removed some permissions from <!-- --><code>ExecStartPre<!-- --></code>, but notably not from <!-- --><code>ExecStart<!-- --></code>.<!-- --></li>
<!-- --><li><code>ExecStartPre=...<!-- --></code> is run before the systemd unit starts up. In this case it ensures that a required directory exists.<!-- --></li>
<!-- --><li><code>ExecStart=...<!-- --></code> should be the command to run the systemd unit itself.<!-- --></li>
<!-- --><li><code>Restart=always<!-- --></code> will cause the process in <!-- --><code>ExecStart<!-- --></code> to be launched again if it ever exits. <!-- --><code>RestartSec=30<!-- --></code> specifies how long to wait before relaunching.<!-- --></li>
<!-- --><li>Finally <!-- --><code>WantedBy=multi-user.target<!-- --></code> is related to how the systemd unit is initially installed.<!-- --></li>
<!-- --></ul>
<!-- --><p>As far as I know, this is a very typical systemd unit. However, especially a unit that handles network activity we want to limit the damage it could cause if it is compromised in any way. For example, a buffer overflow within opensnitch may allow the attacker to execute arbitrary command in the process of the systemd unit.<!-- --></p>
<!-- --><p>My first attempt to tackle this was to look at the <!-- --><a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html">official documentation<!-- --></a>. The density of the documentation makes it quite challenging to understand best practices. Instead I turned to <!-- --><a href="https://www.freedesktop.org/software/systemd/man/systemd-analyze.html">systemd-analyze security<!-- --></a>. This command spits out a long list of things that can be improved:<!-- --></p>
<!-- --><pre><code class="hljs language-ini">  NAME                                                        DESCRIPTION                                                             EXPOSURE
✗ <!-- --><span class="hljs-attr">PrivateNetwork<!-- --></span>=                                             Service has access to the host<!-- --><span class="hljs-string">&#x27;s network                                     0.5
✗ User=/DynamicUser=                                          Service runs as root user                                                    0.4
✗ CapabilityBoundingSet=~CAP_SET(UID|GID|PCAP)                Service may change UID/GID identities/capabilities                           0.3
✗ CapabilityBoundingSet=~CAP_SYS_ADMIN                        Service has administrator privileges                                         0.3
✗ CapabilityBoundingSet=~CAP_SYS_PTRACE                       Service has ptrace() debugging abilities                                     0.3
✗ RestrictAddressFamilies=~AF_(INET|INET6)                    Service may allocate Internet sockets                                        0.3
✗ RestrictNamespaces=~CLONE_NEWUSER                           Service may create user namespaces                                           0.3
✗ RestrictAddressFamilies=~…                                  Service may allocate exotic sockets                                          0.3
✗ CapabilityBoundingSet=~CAP_(CHOWN|FSETID|SETFCAP)           Service may change file ownership/access mode/capabilities unrestricted      0.2
✗ CapabilityBoundingSet=~CAP_(DAC_*|FOWNER|IPC_OWNER)         Service may override UNIX file/IPC permission checks                         0.2
✗ CapabilityBoundingSet=~CAP_NET_ADMIN                        Service has network configuration privileges                                 0.2
✗ CapabilityBoundingSet=~CAP_RAWIO                            Service has raw I/O access                                                   0.2
✗ CapabilityBoundingSet=~CAP_SYS_MODULE                       Service may load kernel modules                                              0.2
✗ CapabilityBoundingSet=~CAP_SYS_TIME                         Service processes may change the system clock                                0.2
✗ DeviceAllow=                                                Service has no device ACL                                                    0.2
✗ IPAddressDeny=                                              Service does not define an IP address whitelist                              0.2
✓ KeyringMode=                                                Service doesn&#x27;<!-- --></span>t share key material with other services
✗ <!-- --><span class="hljs-attr">NoNewPrivileges<!-- --></span>=                                            Service processes may acquire new privileges                                 <!-- --><span class="hljs-number">0.2<!-- --></span>
✓ <!-- --><span class="hljs-attr">NotifyAccess<!-- --></span>=                                               Service child processes cannot alter service state
✗ <!-- --><span class="hljs-attr">PrivateDevices<!-- --></span>=                                             Service potentially has access to hardware devices                           <!-- --><span class="hljs-number">0.2<!-- --></span>
✗ <!-- --><span class="hljs-attr">PrivateMounts<!-- --></span>=                                              Service may install system mounts                                            <!-- --><span class="hljs-number">0.2<!-- --></span>
✗ <!-- --><span class="hljs-attr">PrivateTmp<!-- --></span>=                                                 Service has access to other software<!-- --><span class="hljs-string">&#x27;s temporary files                       0.2
✗ PrivateUsers=                                               Service has access to other users                                            0.2
✗ ProtectControlGroups=                                       Service may modify to the control group file system                          0.2
✗ ProtectHome=                                                Service has full access to home directories                                  0.2
✗ ProtectKernelModules=                                       Service may load or read kernel modules                                      0.2
✗ ProtectKernelTunables=                                      Service may alter kernel tunables                                            0.2
✗ ProtectSystem=                                              Service has full access to the OS file hierarchy                             0.2
✗ RestrictAddressFamilies=~AF_PACKET                          Service may allocate packet sockets                                          0.2
✗ SystemCallArchitectures=                                    Service may execute system calls with all ABIs                               0.2
✗ SystemCallFilter=~@clock                                    Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@debug                                    Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@module                                   Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@mount                                    Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@raw-io                                   Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@reboot                                   Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@swap                                     Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@privileged                               Service does not filter system calls                                         0.2
✗ SystemCallFilter=~@resources                                Service does not filter system calls                                         0.2
✓ AmbientCapabilities=                                        Service process does not receive ambient capabilities
✗ CapabilityBoundingSet=~CAP_AUDIT_*                          Service has audit subsystem access                                           0.1
✗ CapabilityBoundingSet=~CAP_KILL                             Service may send UNIX signals to arbitrary processes                         0.1
✗ CapabilityBoundingSet=~CAP_MKNOD                            Service may create device nodes                                              0.1
✗ CapabilityBoundingSet=~CAP_NET_(BIND_SERVICE|BROADCAST|RAW) Service has elevated networking privileges                                   0.1
✗ CapabilityBoundingSet=~CAP_SYSLOG                           Service has access to kernel logging                                         0.1
✗ CapabilityBoundingSet=~CAP_SYS_(NICE|RESOURCE)              Service has privileges to change resource use parameters                     0.1
✗ RestrictNamespaces=~CLONE_NEWCGROUP                         Service may create cgroup namespaces                                         0.1
✗ RestrictNamespaces=~CLONE_NEWIPC                            Service may create IPC namespaces                                            0.1
✗ RestrictNamespaces=~CLONE_NEWNET                            Service may create network namespaces                                        0.1
✗ RestrictNamespaces=~CLONE_NEWNS                             Service may create file system namespaces                                    0.1
✗ RestrictNamespaces=~CLONE_NEWPID                            Service may create process namespaces                                        0.1
✗ RestrictRealtime=                                           Service may acquire realtime scheduling                                      0.1
✗ SystemCallFilter=~@cpu-emulation                            Service does not filter system calls                                         0.1
✗ SystemCallFilter=~@obsolete                                 Service does not filter system calls                                         0.1
✗ RestrictAddressFamilies=~AF_NETLINK                         Service may allocate netlink sockets                                         0.1
✗ RootDirectory=/RootImage=                                   Service runs within the host&#x27;<!-- --></span>s root directory                                <!-- --><span class="hljs-number">0.1<!-- --></span>
  <!-- --><span class="hljs-attr">SupplementaryGroups<!-- --></span>=                                        Service runs as root, option does not matter
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_MAC_*                            Service may adjust SMACK MAC                                                 <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_SYS_BOOT                         Service may issue reboot()                                                   <!-- --><span class="hljs-number">0.1<!-- --></span>
✓ <!-- --><span class="hljs-attr">Delegate<!-- --></span>=                                                   Service does not maintain its own delegated control group subtree
✗ <!-- --><span class="hljs-attr">LockPersonality<!-- --></span>=                                            Service may change ABI personality                                           <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">MemoryDenyWriteExecute<!-- --></span>=                                     Service may create writable executable memory mappings                       <!-- --><span class="hljs-number">0.1<!-- --></span>
  <!-- --><span class="hljs-attr">RemoveIPC<!-- --></span>=                                                  Service runs as root, option does not apply
✗ <!-- --><span class="hljs-attr">RestrictNamespaces<!-- --></span>=~CLONE_NEWUTS                            Service may create hostname namespaces                                       <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">UMask<!-- --></span>=                                                      Files created by service are world-readable by default                       <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_LINUX_IMMUTABLE                  Service may mark files immutable                                             <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_IPC_LOCK                         Service may lock memory into RAM                                             <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_SYS_CHROOT                       Service may issue chroot()                                                   <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_BLOCK_SUSPEND                    Service may establish wake locks                                             <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_LEASE                            Service may create file leases                                               <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_SYS_PACCT                        Service may use acct()                                                       <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_SYS_TTY_CONFIG                   Service may issue vhangup()                                                  <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">CapabilityBoundingSet<!-- --></span>=~CAP_WAKE_ALARM                       Service may program timers that wake up the system                           <!-- --><span class="hljs-number">0.1<!-- --></span>
✗ <!-- --><span class="hljs-attr">RestrictAddressFamilies<!-- --></span>=~AF_UNIX                            Service may allocate local sockets                                           <!-- --><span class="hljs-number">0.1<!-- --></span>

→ Overall exposure level for opensnitch.service: 9.5 UNSAFE 😨
<!-- --></code></pre>
<!-- --><p>This list provides some indication of settings that can be improved to lower the risk the service poses to the rest of the system. Of course we still need to evaluate every rule qualitatively to understand the impact it will have on our application. <!-- --><code>opensnitch<!-- --></code> in particular proved itself to be finicky, since it (1) is an application firewall, and (2) it does not always fail hard (requests just hang for some systemd settings).<!-- --></p>
<!-- --><p>The official documentation does a better job at explaining the individual options, but I would still like to highlight some options that I consider particular important:<!-- --></p>
<!-- --><ul>
<!-- --><li><code>DynamicUser<!-- --></code> or <!-- --><code>User<!-- --></code> allows you to pick a user other than root to run the systemd unit. In my personal opinion, this option is the most important to reduce access to the host system (when used in conjunction with <!-- --><code>NoNewPrivileges<!-- --></code>).<!-- --></li>
<!-- --><li><code>PrivateNetwork<!-- --></code>, <!-- --><code>IPAddressDeny<!-- --></code> and <!-- --><code>IPAddressAllow<!-- --></code> allow you to reduce the network access for a systemd unit. In many cases, this is the best way to prevent a compromised systemd unit to upload data to an external system.<!-- --></li>
<!-- --><li><code>CapabilityBoundingSet<!-- --></code> combined with <!-- --><code>AmbientCapabilities<!-- --></code> will allow you to give the systemd unit some limited superuser capabilities. This came in handy for <!-- --><code>opensnitch<!-- --></code>, since it leverages quite a bit of kernel functionality.<!-- --></li>
<!-- --></ul>
<!-- --><p>Unfortunately the last point was a significant point of frustration for <!-- --><code>opensnitch<!-- --></code>, since it was hard to determine what capabilities are needed. The tools I found online did not seem to solve my problems. <!-- --><a href="https://man7.org/linux/man-pages/man8/getpcaps.8.html">getpcaps<!-- --></a> printed the capaibilites that a process had, not the ones that it was using. I was unable to run <!-- --><a href="https://www.brendangregg.com/blog/2016-10-01/linux-bcc-security-capabilities.html">capable<!-- --></a> successfully. And <!-- --><code>strace<!-- --></code> did not log the used capabilities. In the end I ended up individually removing capabilities to determine which ones were required.<!-- --></p>
<!-- --><h1>Protonmail<!-- --></h1>
<!-- --><p>For <!-- --><code>protonmail<!-- --></code> I went back to <!-- --><code>systemd-analyze security --user<!-- --></code> to find what settings can be improved. Unfortunately almost every single setting caused the systemd service to fail to start with an error message:<!-- --></p>
<!-- --><pre><code class="hljs language-vbnet">Failed <!-- --><span class="hljs-keyword">to<!-- --></span> drop capabilities: Operation <!-- --><span class="hljs-built_in">not<!-- --></span> permitted
Failed at <!-- --><span class="hljs-keyword">step<!-- --></span> CAPABILITIES spawning /you-<!-- --><span class="hljs-keyword">binary<!-- --></span>-path: Operation <!-- --><span class="hljs-built_in">not<!-- --></span> permitted
<!-- --></code></pre>
<!-- --><p>Even limiting the set of possible capabilites, such as with <!-- --><code>CapabilityBoundingSet<!-- --></code> did not work. After a lot of head scratching, <!-- --><a href="https://github.com/systemd/systemd/issues/4959">this github issue<!-- --></a> explained that the user does not have the ability to reduce its own permissions. Frustratingly, setting options such as <!-- --><code>ProtectProc<!-- --></code> is not possible to apply, since it <!-- --><strong>implicitly<!-- --></strong> affects the capabilities.<!-- --></p>
<!-- --><h1>Conclusion<!-- --></h1>
<!-- --><p>While I outline weaknesses of <!-- --><code>systemd<!-- --></code> and <!-- --><code>opensnitch<!-- --></code>, I am eternally grateful to the maintainers for building those tools. I hope that there will be more of an investment into this in the future. Unfortunately, even on a new debian install the systemd services are mostly considerd unsafe:<!-- --></p>
<!-- --><pre><code class="hljs language-ruby"><span class="hljs-variable">$ <!-- --></span>systemd-analyze security
UNIT                                 EXPOSURE PREDICATE HAPPY
cron.service                              <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
dbus.service                              <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
emergency.service                         <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
getty<!-- --><span class="hljs-variable">@tty1<!-- --></span>.service                        <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
ifup<!-- --><span class="hljs-variable">@eth0<!-- --></span>.service                         <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
opensnitch.service                        <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
rc-local.service                          <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
<!-- --><span class="hljs-keyword">rescue<!-- --></span>.service                            <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
rsync.service                             <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
rsyslog.service                           <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
ssh.service                               <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
systemd-ask-password-console.service      <!-- --><span class="hljs-number">9.3<!-- --></span> UNSAFE    😨
systemd-ask-password-wall.service         <!-- --><span class="hljs-number">9.3<!-- --></span> UNSAFE    😨
systemd-fsckd.service                     <!-- --><span class="hljs-number">9.5<!-- --></span> UNSAFE    😨
systemd-initctl.service                   <!-- --><span class="hljs-number">9.3<!-- --></span> UNSAFE    😨
systemd-journald.service                  <!-- --><span class="hljs-number">4.3<!-- --></span> OK        🙂
systemd-logind.service                    <!-- --><span class="hljs-number">4.1<!-- --></span> OK        🙂
systemd-networkd.service                  <!-- --><span class="hljs-number">2.8<!-- --></span> OK        🙂
systemd-timesyncd.service                 <!-- --><span class="hljs-number">2.0<!-- --></span> OK        🙂
systemd-udevd.service                     <!-- --><span class="hljs-number">8.3<!-- --></span> EXPOSED   🙁
user<!-- --><span class="hljs-variable">@1000<!-- --></span>.service                         <!-- --><span class="hljs-number">9.1<!-- --></span> UNSAFE    😨
<!-- --></code></pre>
<!-- --><p>With that in mind, I don&#x27;t see this situation changing anytime soon. Instead the best hope may be that security conscious developers contribute their systemd unit files to upstream repositories. I&#x27;ll update this post with a PR to improve the <!-- --><code>opensnitch<!-- --></code> service unit soon.<!-- --></p><p class="MuiTypography-root MuiTypography-body1 css-1bw4yx3">Published on <!-- -->2021-12-26<!-- -->.<!-- --></p></div></div><hr class="border-accent-2 mt-28 mb-24"/><div><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">More Stories</h4><div class="MuiMasonry-root css-g8y262"><div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><button class="MuiButtonBase-root MuiCardActionArea-root css-1jluznr" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-1tqdl5x" href="/posts/variants-are-powerful"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">Variants are incredibly powerful</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Variants are an incredibly powerful tool to express the state of your program!</p></a><span class="MuiCardActionArea-focusHighlight css-jo3ec3"></span></button></div></div></div><div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-s18byi"><img class="MuiCardMedia-root MuiCardMedia-media MuiCardMedia-img css-rhsghg"/><div class="MuiCardContent-root css-1qw96cp"><button class="MuiButtonBase-root MuiCardActionArea-root css-1jluznr" tabindex="0" type="button"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone css-1tqdl5x" href="/posts/avoid-generic-types"><div class="MuiBox-root css-k008qs"><div class="MuiBox-root css-i9gxme"><h4 class="MuiTypography-root MuiTypography-h4 css-1f04t6y">Avoiding generic types for safer code</h4></div><div class="MuiBox-root css-56sg73"><div class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeMedium MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-genwvd" tabindex="0" href="/author/nigel-schuster"><div class="MuiAvatar-root MuiAvatar-circular MuiChip-avatar MuiChip-avatarMedium MuiChip-avatarColorDefault css-3i9vrz"><img alt="Nigel Schuster" src="https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6" class="MuiAvatar-img css-1hy9t21"/></div><span class="MuiChip-label MuiChip-labelMedium css-9iedg7">Nigel Schuster</span></div></div></div><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Using generic types like strings made me make mistakes on several occasion. There is a better way.</p></a><span class="MuiCardActionArea-focusHighlight css-jo3ec3"></span></button></div></div></div></div></div></div></main></div><footer><div class="MuiContainer-root MuiContainer-maxWidthLg css-1qsxih2"><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Built with NextJS. Find the source <!-- --><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-1c0wj8h" href="https://github.com/Neitsch/neitsch.github.io">here</a>.<!-- --></p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"__typename":"Post","title":"Systemd Services are frustratingly hard to make safe","slug":"systemd-frustration","content":"Today's story starts with me wanting to reduce the permissions of some of the systemd services I run. The two services I set my sight on were [opensnitch](https://github.com/evilsocket/opensnitch), a system service, and [protonmail-bridge](https://github.com/ProtonMail/proton-bridge), a user service.\n\n# Opensnitch\n\nConveniently opensnitch provides a working [systemd unit](https://github.com/evilsocket/opensnitch/blob/0d1e9f5b4750cc7932eb42618d7c4b2b87022dc7/daemon/opensnitchd.service):\n```\n[Unit]\nDescription=OpenSnitch is a GNU/Linux port of the Little Snitch application firewall.\nDocumentation=https://github.com/gustavo-iniguez-goya/opensnitch/wiki\nWants=network.target\nAfter=network.target\n\n[Service]\nType=simple\nPermissionsStartOnly=true\nExecStartPre=/bin/mkdir -p /etc/opensnitchd/rules\nExecStart=/usr/local/bin/opensnitchd -rules-path /etc/opensnitchd/rules\nRestart=always\nRestartSec=30\n\n[Install]\nWantedBy=multi-user.target\n```\nLet's break down what this unit does:\n* `Description` and `Documentation` are quite self explanatory and don't affect the runtime of the unit.\n* `Wants=network.target` means that this service may only be started after the networking layer has been initialized.\n* `After=network.target` means that this service should automatically be started once the networking layer has been initialized.\n* `Type=simple` specifies how the unit launches. `simple` is often the right choice, but processes that daemonize itself for example will be `forking`.\n* `PermissionsStartOnly=true` is a deprecated attribute that removed some permissions from `ExecStartPre`, but notably not from `ExecStart`.\n* `ExecStartPre=...` is run before the systemd unit starts up. In this case it ensures that a required directory exists.\n* `ExecStart=...` should be the command to run the systemd unit itself.\n* `Restart=always` will cause the process in `ExecStart` to be launched again if it ever exits. `RestartSec=30` specifies how long to wait before relaunching.\n* Finally `WantedBy=multi-user.target` is related to how the systemd unit is initially installed.\n\nAs far as I know, this is a very typical systemd unit. However, especially a unit that handles network activity we want to limit the damage it could cause if it is compromised in any way. For example, a buffer overflow within opensnitch may allow the attacker to execute arbitrary command in the process of the systemd unit.\n\nMy first attempt to tackle this was to look at the [official documentation](https://www.freedesktop.org/software/systemd/man/systemd.exec.html). The density of the documentation makes it quite challenging to understand best practices. Instead I turned to [systemd-analyze security](https://www.freedesktop.org/software/systemd/man/systemd-analyze.html). This command spits out a long list of things that can be improved:\n```\n  NAME                                                        DESCRIPTION                                                             EXPOSURE\n✗ PrivateNetwork=                                             Service has access to the host's network                                     0.5\n✗ User=/DynamicUser=                                          Service runs as root user                                                    0.4\n✗ CapabilityBoundingSet=~CAP_SET(UID|GID|PCAP)                Service may change UID/GID identities/capabilities                           0.3\n✗ CapabilityBoundingSet=~CAP_SYS_ADMIN                        Service has administrator privileges                                         0.3\n✗ CapabilityBoundingSet=~CAP_SYS_PTRACE                       Service has ptrace() debugging abilities                                     0.3\n✗ RestrictAddressFamilies=~AF_(INET|INET6)                    Service may allocate Internet sockets                                        0.3\n✗ RestrictNamespaces=~CLONE_NEWUSER                           Service may create user namespaces                                           0.3\n✗ RestrictAddressFamilies=~…                                  Service may allocate exotic sockets                                          0.3\n✗ CapabilityBoundingSet=~CAP_(CHOWN|FSETID|SETFCAP)           Service may change file ownership/access mode/capabilities unrestricted      0.2\n✗ CapabilityBoundingSet=~CAP_(DAC_*|FOWNER|IPC_OWNER)         Service may override UNIX file/IPC permission checks                         0.2\n✗ CapabilityBoundingSet=~CAP_NET_ADMIN                        Service has network configuration privileges                                 0.2\n✗ CapabilityBoundingSet=~CAP_RAWIO                            Service has raw I/O access                                                   0.2\n✗ CapabilityBoundingSet=~CAP_SYS_MODULE                       Service may load kernel modules                                              0.2\n✗ CapabilityBoundingSet=~CAP_SYS_TIME                         Service processes may change the system clock                                0.2\n✗ DeviceAllow=                                                Service has no device ACL                                                    0.2\n✗ IPAddressDeny=                                              Service does not define an IP address whitelist                              0.2\n✓ KeyringMode=                                                Service doesn't share key material with other services\n✗ NoNewPrivileges=                                            Service processes may acquire new privileges                                 0.2\n✓ NotifyAccess=                                               Service child processes cannot alter service state\n✗ PrivateDevices=                                             Service potentially has access to hardware devices                           0.2\n✗ PrivateMounts=                                              Service may install system mounts                                            0.2\n✗ PrivateTmp=                                                 Service has access to other software's temporary files                       0.2\n✗ PrivateUsers=                                               Service has access to other users                                            0.2\n✗ ProtectControlGroups=                                       Service may modify to the control group file system                          0.2\n✗ ProtectHome=                                                Service has full access to home directories                                  0.2\n✗ ProtectKernelModules=                                       Service may load or read kernel modules                                      0.2\n✗ ProtectKernelTunables=                                      Service may alter kernel tunables                                            0.2\n✗ ProtectSystem=                                              Service has full access to the OS file hierarchy                             0.2\n✗ RestrictAddressFamilies=~AF_PACKET                          Service may allocate packet sockets                                          0.2\n✗ SystemCallArchitectures=                                    Service may execute system calls with all ABIs                               0.2\n✗ SystemCallFilter=~@clock                                    Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@debug                                    Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@module                                   Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@mount                                    Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@raw-io                                   Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@reboot                                   Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@swap                                     Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@privileged                               Service does not filter system calls                                         0.2\n✗ SystemCallFilter=~@resources                                Service does not filter system calls                                         0.2\n✓ AmbientCapabilities=                                        Service process does not receive ambient capabilities\n✗ CapabilityBoundingSet=~CAP_AUDIT_*                          Service has audit subsystem access                                           0.1\n✗ CapabilityBoundingSet=~CAP_KILL                             Service may send UNIX signals to arbitrary processes                         0.1\n✗ CapabilityBoundingSet=~CAP_MKNOD                            Service may create device nodes                                              0.1\n✗ CapabilityBoundingSet=~CAP_NET_(BIND_SERVICE|BROADCAST|RAW) Service has elevated networking privileges                                   0.1\n✗ CapabilityBoundingSet=~CAP_SYSLOG                           Service has access to kernel logging                                         0.1\n✗ CapabilityBoundingSet=~CAP_SYS_(NICE|RESOURCE)              Service has privileges to change resource use parameters                     0.1\n✗ RestrictNamespaces=~CLONE_NEWCGROUP                         Service may create cgroup namespaces                                         0.1\n✗ RestrictNamespaces=~CLONE_NEWIPC                            Service may create IPC namespaces                                            0.1\n✗ RestrictNamespaces=~CLONE_NEWNET                            Service may create network namespaces                                        0.1\n✗ RestrictNamespaces=~CLONE_NEWNS                             Service may create file system namespaces                                    0.1\n✗ RestrictNamespaces=~CLONE_NEWPID                            Service may create process namespaces                                        0.1\n✗ RestrictRealtime=                                           Service may acquire realtime scheduling                                      0.1\n✗ SystemCallFilter=~@cpu-emulation                            Service does not filter system calls                                         0.1\n✗ SystemCallFilter=~@obsolete                                 Service does not filter system calls                                         0.1\n✗ RestrictAddressFamilies=~AF_NETLINK                         Service may allocate netlink sockets                                         0.1\n✗ RootDirectory=/RootImage=                                   Service runs within the host's root directory                                0.1\n  SupplementaryGroups=                                        Service runs as root, option does not matter\n✗ CapabilityBoundingSet=~CAP_MAC_*                            Service may adjust SMACK MAC                                                 0.1\n✗ CapabilityBoundingSet=~CAP_SYS_BOOT                         Service may issue reboot()                                                   0.1\n✓ Delegate=                                                   Service does not maintain its own delegated control group subtree\n✗ LockPersonality=                                            Service may change ABI personality                                           0.1\n✗ MemoryDenyWriteExecute=                                     Service may create writable executable memory mappings                       0.1\n  RemoveIPC=                                                  Service runs as root, option does not apply\n✗ RestrictNamespaces=~CLONE_NEWUTS                            Service may create hostname namespaces                                       0.1\n✗ UMask=                                                      Files created by service are world-readable by default                       0.1\n✗ CapabilityBoundingSet=~CAP_LINUX_IMMUTABLE                  Service may mark files immutable                                             0.1\n✗ CapabilityBoundingSet=~CAP_IPC_LOCK                         Service may lock memory into RAM                                             0.1\n✗ CapabilityBoundingSet=~CAP_SYS_CHROOT                       Service may issue chroot()                                                   0.1\n✗ CapabilityBoundingSet=~CAP_BLOCK_SUSPEND                    Service may establish wake locks                                             0.1\n✗ CapabilityBoundingSet=~CAP_LEASE                            Service may create file leases                                               0.1\n✗ CapabilityBoundingSet=~CAP_SYS_PACCT                        Service may use acct()                                                       0.1\n✗ CapabilityBoundingSet=~CAP_SYS_TTY_CONFIG                   Service may issue vhangup()                                                  0.1\n✗ CapabilityBoundingSet=~CAP_WAKE_ALARM                       Service may program timers that wake up the system                           0.1\n✗ RestrictAddressFamilies=~AF_UNIX                            Service may allocate local sockets                                           0.1\n\n→ Overall exposure level for opensnitch.service: 9.5 UNSAFE 😨\n```\nThis list provides some indication of settings that can be improved to lower the risk the service poses to the rest of the system. Of course we still need to evaluate every rule qualitatively to understand the impact it will have on our application. `opensnitch` in particular proved itself to be finicky, since it (1) is an application firewall, and (2) it does not always fail hard (requests just hang for some systemd settings).\n\nThe official documentation does a better job at explaining the individual options, but I would still like to highlight some options that I consider particular important:\n* `DynamicUser` or `User` allows you to pick a user other than root to run the systemd unit. In my personal opinion, this option is the most important to reduce access to the host system (when used in conjunction with `NoNewPrivileges`).\n* `PrivateNetwork`, `IPAddressDeny` and `IPAddressAllow` allow you to reduce the network access for a systemd unit. In many cases, this is the best way to prevent a compromised systemd unit to upload data to an external system.\n* `CapabilityBoundingSet` combined with `AmbientCapabilities` will allow you to give the systemd unit some limited superuser capabilities. This came in handy for `opensnitch`, since it leverages quite a bit of kernel functionality.\n\nUnfortunately the last point was a significant point of frustration for `opensnitch`, since it was hard to determine what capabilities are needed. The tools I found online did not seem to solve my problems. [getpcaps](https://man7.org/linux/man-pages/man8/getpcaps.8.html) printed the capaibilites that a process had, not the ones that it was using. I was unable to run [capable](https://www.brendangregg.com/blog/2016-10-01/linux-bcc-security-capabilities.html) successfully. And `strace` did not log the used capabilities. In the end I ended up individually removing capabilities to determine which ones were required.\n\n# Protonmail\n\nFor `protonmail` I went back to `systemd-analyze security --user` to find what settings can be improved. Unfortunately almost every single setting caused the systemd service to fail to start with an error message:\n```\nFailed to drop capabilities: Operation not permitted\nFailed at step CAPABILITIES spawning /you-binary-path: Operation not permitted\n```\nEven limiting the set of possible capabilites, such as with `CapabilityBoundingSet` did not work. After a lot of head scratching, [this github issue](https://github.com/systemd/systemd/issues/4959) explained that the user does not have the ability to reduce its own permissions. Frustratingly, setting options such as `ProtectProc` is not possible to apply, since it **implicitly** affects the capabilities.\n\n# Conclusion\n\nWhile I outline weaknesses of `systemd` and `opensnitch`, I am eternally grateful to the maintainers for building those tools. I hope that there will be more of an investment into this in the future. Unfortunately, even on a new debian install the systemd services are mostly considerd unsafe:\n```\n$ systemd-analyze security\nUNIT                                 EXPOSURE PREDICATE HAPPY\ncron.service                              9.5 UNSAFE    😨\ndbus.service                              9.5 UNSAFE    😨\nemergency.service                         9.5 UNSAFE    😨\ngetty@tty1.service                        9.5 UNSAFE    😨\nifup@eth0.service                         9.5 UNSAFE    😨\nopensnitch.service                        9.5 UNSAFE    😨\nrc-local.service                          9.5 UNSAFE    😨\nrescue.service                            9.5 UNSAFE    😨\nrsync.service                             9.5 UNSAFE    😨\nrsyslog.service                           9.5 UNSAFE    😨\nssh.service                               9.5 UNSAFE    😨\nsystemd-ask-password-console.service      9.3 UNSAFE    😨\nsystemd-ask-password-wall.service         9.3 UNSAFE    😨\nsystemd-fsckd.service                     9.5 UNSAFE    😨\nsystemd-initctl.service                   9.3 UNSAFE    😨\nsystemd-journald.service                  4.3 OK        🙂\nsystemd-logind.service                    4.1 OK        🙂\nsystemd-networkd.service                  2.8 OK        🙂\nsystemd-timesyncd.service                 2.0 OK        🙂\nsystemd-udevd.service                     8.3 EXPOSED   🙁\nuser@1000.service                         9.1 UNSAFE    😨\n```\nWith that in mind, I don't see this situation changing anytime soon. Instead the best hope may be that security conscious developers contribute their systemd unit files to upstream repositories. I'll update this post with a PR to improve the `opensnitch` service unit soon.","date":"2021-12-26","ogImage":null,"coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}},"moreStories":[{"__typename":"Post","title":"Variants are incredibly powerful","slug":"variants-are-powerful","excerpt":"Variants are an incredibly powerful tool to express the state of your program!","coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}},{"__typename":"Post","title":"Avoiding generic types for safer code","slug":"avoid-generic-types","excerpt":"Using generic types like strings made me make mistakes on several occasion. There is a better way.","coverImage":null,"author":{"__typename":"Author","name":"Nigel Schuster","slug":"nigel-schuster","picture":{"__typename":"Asset","url":"https://media.graphassets.com/resize=fit:crop,height:100,width:100/1bF1qLxsSbElgNK5x6t6"}}}],"__typename":"Query"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"systemd-frustration"},"buildId":"Dr3hmog3a1IWTPaX95YpU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>